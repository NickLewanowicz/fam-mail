# Fam Mail 1.0.0 Design

**Date:** 2026-01-03
**Status:** Approved
**Version:** 1.0.0

## Overview

Fam Mail is an email-to-postcard conversion service. It monitors an email inbox, detects postcard requests via subject line filtering, uses an LLM to parse email content into a PostGrid API payload, and sends physical postcards via USPS.

## Architecture

### Core Flow

1. IMAP polling service watches configured inbox(es)
2. Emails matching the subject filter (default "Fammail Postcard") trigger processing
3. LLM (OpenRouter/Ollama/custom endpoint) parses email to extract: recipient address, message, and image reference
4. Parsed payload sent to PostGrid API
5. Postcard mailed physically
6. Success/failure notification emailed back to sender

### Components

**Backend:** Bun + TypeScript (port 8484)
- IMAP polling service (imap-flow library)
- LLM integration with configurable provider
- PostGrid API client
- Webhook handlers for PostGrid status updates
- REST API for manual testing and status checking
- SQLite database for tracking processed emails

**Frontend:** Vite + React (port 5173 dev, served by backend in prod)
- Manual postcard creation for testing
- Real-time preview with safe zones
- Status dashboard for recent postcards

**Deployment:** Docker with single .env configuration

---

## Email Parsing with LLM

### Prompt Strategy

System prompt defines the task: extract recipient, message, image reference from email context.

### Response Schema

```json
{
  "recipient": {
    "name": "string",
    "addressLine1": "string",
    "addressLine2": "string (optional)",
    "city": "string",
    "state": "string",
    "zipCode": "string",
    "country": "string (default US)"
  },
  "message": "string (markdown formatted)",
  "imageReference": "string (URL, attachment ID, or description for AI generation)"
}
```

### Configuration (.env)

```bash
LLM_PROVIDER=openrouter|ollama|custom
LLM_API_KEY=sk-...
LLM_MODEL=openai/gpt-4o
LLM_ENDPOINT=https://openrouter.ai/api/v1
LLM_MAX_TOKENS=1000
```

### Error Handling

- Invalid JSON response → Notify sender with parsing error
- Missing required fields → Notify sender what's missing
- LLM timeout → Retry once, then notify

---

## IMAP Polling & Email Processing

### Library

`imap-flow` (modern, promise-based, supports IDLE for real-time updates)

### Polling Strategy

1. **Initial sync**: Configurable lookback window (default: 0 days = only new emails)
2. **IDLE mode**: Use IMAP IDLE if supported for push notifications
3. **Fallback polling**: 30-second interval if IDLE unavailable

### Catch-Up Modes

- **`none`** (default): Skip all historical emails, only process new emails after startup
- **`process`**: Actually resend postcards for all matching emails in lookback window
- **`dry-run`**: Mark emails as processed in DB without calling PostGrid

### Email Processing Pipeline

```
1. New email detected → Check subject filter
2. Matches filter? → Check DB if already processed
3. Not processed? → Mark as processing, fetch full content
4. Validate: MUST have image attachment → Error if missing
5. Extract: subject, body (text/html), attachments (images only)
6. Send to LLM for parsing (include image as attachment context)
7. Validate LLM response
8. Send payload to PostGrid (skip in dry-run mode)
9. Store result + mark email as processed
10. Send confirmation email to sender
```

### Configuration (.env)

```bash
EMAIL_PROVIDER=imap.gmail.com|imap.purelymail.com|custom
IMAP_HOST=imap.example.com
IMAP_PORT=993
IMAP_USER=your@email.com
IMAP_PASSWORD=app-specific-password
IMAP_TLS=true
IMAP_INBOX=INBOX
SUBJECT_FILTER=Fammail Postcard
POLL_INTERVAL_SECONDS=30
INITIAL_SYNC_DAYS=0
CATCH_UP_MODE=none
REQUIRE_IMAGE_ATTACHMENT=true
```

### Attachment Handling

- **Required**: At least one image attachment (jpg, png, webp)
- Images < 5MB: Include as postcard front
- Multiple images: Use first image, warn about extras
- Non-image attachments: Ignore with warning

---

## PostGrid Integration

### API Endpoints

- **Create Postcard**: `POST /v1/postcards`
- **Get Postcard**: `GET /v1/postcards/{id}`
- **Webhook**: Inbound status updates (delivered, failed, returned)

### Environment Selection

- **Test mode**: Uses PostGrid test API, no actual postcards sent, free for development
- **Live mode**: Real postcards sent via USPS, costs apply
- **Force test mode**: Safety override that ignores POSTGRID_MODE and always uses test API

### Request Payload

```typescript
{
  to: { name, addressLine1, addressLine2, city, state, zipCode, country },
  front: { imageUrl: "base64 or URL from attachment" },
  back: { message: "markdown converted to HTML", withPostage: true },
  metadata: {
    emailMessageId: "...",
    senderEmail: "...",
    originalSubject: "...",
    environment: "test|live",
    forcedTestMode: true|false
  }
}
```

### Configuration (.env)

```bash
POSTGRID_MODE=test|live
POSTGRID_TEST_API_KEY=pg_test_...
POSTGRID_LIVE_API_KEY=pg_live_...
POSTGRID_FORCE_TEST_MODE=false
POSTGRID_WEBHOOK_SECRET=webhook_secret_to_verify
POSTCARD_SIZE=4x6
POSTCARD_SENDER_ID=default_sender_id_from_postgrid
```

### Safety Check

- If `POSTGRID_FORCE_TEST_MODE=true`, all postcards use test key regardless of `POSTGRID_MODE`
- Logs warning on startup when force test mode is enabled
- Metadata includes `forcedTestMode: true` for tracking

---

## Database Schema (SQLite)

```sql
CREATE TABLE postcards (
  id TEXT PRIMARY KEY,
  emailMessageId TEXT UNIQUE,
  senderEmail TEXT,
  recipientName TEXT,
  recipientAddress TEXT,
  postgridPostcardId TEXT,
  postgridMode TEXT, -- test or live
  forcedTestMode BOOLEAN, -- true if safety override was active
  status TEXT, -- processing, sent, delivered, failed, returned
  errorMessage TEXT,
  createdAt TEXT,
  updatedAt TEXT
);
```

---

## Error Handling & Retry Logic

| Error Type | Action |
|------------|--------|
| Invalid address (LLM parsing) | Email sender with error + original email for reference |
| PostGrid API timeout | Retry 3x with exponential backoff (1s, 5s, 15s) |
| PostGrid API error (4xx) | No retry, email sender with error details |
| PostGrid API error (5xx) | Retry 3x, then email sender with failure notice |
| Missing image attachment | Email sender: "Postcard requires an image attachment" |
| Image too large | Email sender: "Image exceeds 5MB limit" |

### Email Notifications

- **Test mode**: "Your postcard to [name] was created in TEST mode (not actually sent)"
- **Force test**: "Your postcard to [name] was created in TEST mode (force test enabled)"
- **Live mode**: "Your postcard to [name] is on the way! Tracking: [url]"
- **Error**: "Couldn't send postcard. Error: [details]. Original email below for reference."

---

## Testing Strategy

### Goals

- Unit tests: 80%+ coverage for core business logic
- Integration tests: LLM parsing, PostGrid API, IMAP flow
- E2E tests: Full email-to-postcard pipeline

### Stack

- **Backend**: Bun test + vi for mocking
- **Frontend**: Vitest + React Testing Library
- **Testcontainers**: For IMAP and database integration tests

### Key Test Areas

1. **LLM Parsing Tests** (unit): Valid email, missing recipient, malformed address, multiple attachments
2. **IMAP Processing Tests** (integration): Subject filter, attachment validation, catch-up modes, duplicate detection
3. **PostGrid Client Tests** (unit): Test/live key usage, force test override, retry logic
4. **Error Handling Tests** (unit): Email notifications, error messages, database records
5. **E2E Tests** (full pipeline): Mock IMAP + Mock PostGrid + Mock LLM

### Test Commands

```bash
pnpm test              # All tests
pnpm test:unit         # Unit tests only
pnpm test:integration  # Integration tests only
pnpm test:e2e          # E2E tests only
pnpm test:coverage     # With coverage report
```

---

## Deployment

### Philosophy

- Single `.env` file for all configuration
- `.env.example` as template with documentation
- Docker-based for consistent deployment
- Works on Unraid, VPS, or local dev

### Server Configuration

```bash
PORT=8484                             # Backend API port (F=M=4,4 -> 8484)
NODE_ENV=production                   # production or development
LOG_LEVEL=info                        # debug, info, warn, error
DATABASE_PATH=/data/fammail.db        # SQLite database path
```

### Docker Compose

```yaml
services:
  fammail:
    image: ghcr.io/your-org/fam-mail:latest
    container_name: fammail
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./data:/data                  # Persist database
      - ./config:/config              # Optional: mount config dir
    ports:
      - "8484:8484"                   # API + frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8484/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### Unraid Deployment

1. Add Container in Unraid Docker tab
2. Set repository: `ghcr.io/your-org/fam-mail:latest`
3. Add environment variables from `.env.example`
4. Map `/data` volume for persistent database
5. Map port `8484:8484`
6. Start container

### VPS Deployment

```bash
git clone https://github.com/your-org/fam-mail.git
cd fam-mail
cp .env.example .env
# Edit .env with your values
docker compose up -d
```

---

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/health` | GET | Health check, returns version and service status |
| `/api/postcards` | POST | Manually trigger postcard creation (testing UI uses this) |
| `/api/postcards` | GET | List all postcards with filters (status, date range) |
| `/api/postcards/:id` | GET | Get details of a specific postcard |
| `/api/postcards/:id/status` | GET | Get current status from PostGrid |
| `/api/webhook/postgrid` | POST | PostGrid webhook for delivery updates |
| `/api/admin/catch-up` | POST | Trigger manual catch-up process |
| `/*` | GET | Serve frontend (production mode) |

---

## 1.0.0 Checklist

- [ ] Complete PostGrid integration (test + live modes)
- [ ] IMAP polling service with catch-up modes
- [ ] LLM parsing with configurable providers
- [ ] Email notifications (success + error)
- [ ] SQLite database for tracking
- [ ] Force test mode safety feature
- [ ] Unit tests (80%+ coverage)
- [ ] Integration tests (IMAP, PostGrid)
- [ ] E2E tests (full pipeline)
- [ ] .env.example documentation
- [ ] Docker setup tested
- [ ] Unraid deployment verified
- [ ] Health check endpoint
- [ ] Webhook handler for PostGrid
- [ ] Error handling and retry logic
- [ ] Image attachment validation
